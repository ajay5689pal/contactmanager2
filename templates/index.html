<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Management App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.25s ease; }
        .modal-active { overflow: hidden; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="mb-8">
            <div class="flex justify-between items-center">
                 <h1 class="text-3xl font-bold text-gray-900">My Contacts</h1>
                 <div class="text-right">
                    <p class="text-gray-700">Welcome, <span class="font-semibold">{{ username }}</span></p>
                    <a href="/logout" class="text-sm text-blue-600 hover:underline">Logout</a>
                 </div>
            </div>
        </header>

        <main>
            <div class="mb-6 flex flex-col sm:flex-row gap-4 items-center">
                <!-- Search Bar -->
                <div class="w-full">
                    <input type="text" id="searchInput" placeholder="Search contacts..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                </div>
                <!-- Add Contact Button -->
                <div class="w-full sm:w-auto">
                    <button id="addContactBtn" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 whitespace-nowrap">
                        Add New Contact
                    </button>
                </div>
            </div>

            <!-- Contacts List -->
            <div id="contactsList" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Contact cards will be inserted here by JavaScript -->
            </div>
             <p id="noContactsMessage" class="hidden text-center text-gray-500 mt-8">No contacts found. Add one to get started!</p>
        </main>
    </div>

    <!-- Modal for Add/Edit Contact -->
    <div id="contactModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="bg-white w-full max-w-md p-6 rounded-xl shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-2xl font-bold">Add Contact</h2>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <form id="contactForm">
                <input type="hidden" id="contactId">
                <div class="mb-4">
                    <label for="name" class="block text-gray-700 font-medium mb-2">Name</label>
                    <input type="text" id="name" name="name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="phone" class="block text-gray-700 font-medium mb-2">Phone</label>
                    <input type="tel" id="phone" name="phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="email" class="block text-gray-700 font-medium mb-2">Email</label>
                    <input type="email" id="email" name="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="flex justify-end space-x-4">
                     <button type="button" id="cancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition duration-300">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">Save Contact</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // The JavaScript remains largely the same as the API endpoints are consistent.
        // Flask-Login handles the authentication redirects automatically.
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = '/api/contacts';
            const contactsList = document.getElementById('contactsList');
            const noContactsMessage = document.getElementById('noContactsMessage');
            const searchInput = document.getElementById('searchInput');

            // Modal elements
            const modal = document.getElementById('contactModal');
            const modalTitle = document.getElementById('modalTitle');
            const addContactBtn = document.getElementById('addContactBtn');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const cancelBtn = document.getElementById('cancelBtn');

            // Form elements
            const contactForm = document.getElementById('contactForm');
            const contactIdInput = document.getElementById('contactId');
            const nameInput = document.getElementById('name');
            const phoneInput = document.getElementById('phone');
            const emailInput = document.getElementById('email');

            const openModal = (title, contact = null) => {
                modalTitle.textContent = title;
                if (contact) {
                    contactIdInput.value = contact.id;
                    nameInput.value = contact.name;
                    phoneInput.value = contact.phone;
                    emailInput.value = contact.email;
                } else {
                    contactForm.reset();
                    contactIdInput.value = '';
                }
                modal.classList.remove('opacity-0', 'pointer-events-none');
                modal.querySelector('div').classList.remove('scale-95');
                document.body.classList.add('modal-active');
            };

            const closeModal = () => {
                modal.classList.add('opacity-0', 'pointer-events-none');
                modal.querySelector('div').classList.add('scale-95');
                document.body.classList.remove('modal-active');
                contactForm.reset();
                contactIdInput.value = '';
            };

            addContactBtn.addEventListener('click', () => openModal('Add New Contact'));
            closeModalBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            const fetchContacts = async (searchTerm = '') => {
                try {
                    const url = searchTerm ? `${API_URL}?search=${encodeURIComponent(searchTerm)}` : API_URL;
                    const response = await fetch(url);
                    if (response.redirected) {
                        window.location.href = response.url;
                        return;
                    }
                    const contacts = await response.json();
                    renderContacts(contacts);
                } catch (error) {
                    console.error('Failed to fetch contacts:', error);
                }
            };

            const saveContact = async (contact) => {
                const id = contactIdInput.value;
                const url = id ? `${API_URL}/${id}` : API_URL;
                const method = id ? 'PUT' : 'POST';

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(contact)
                    });
                    if (!response.ok) throw new Error('Failed to save contact');
                    closeModal();
                    fetchContacts(searchInput.value);
                } catch (error) {
                    console.error('Error saving contact:', error);
                }
            };
            
            const deleteContact = async (id) => {
                // Using a custom modal for confirmation would be better than confirm()
                // but for simplicity, we'll keep it.
                if (!confirm('Are you sure you want to delete this contact?')) return;
                try {
                    const response = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Failed to delete contact');
                    fetchContacts(searchInput.value);
                } catch (error) {
                    console.error('Error deleting contact:', error);
                }
            };

            const renderContacts = (contacts) => {
                contactsList.innerHTML = '';
                if (contacts.length === 0) {
                    noContactsMessage.classList.remove('hidden');
                    const searchTerm = searchInput.value;
                    if(searchTerm) {
                        noContactsMessage.textContent = `No contacts found for "${searchTerm}".`;
                    } else {
                        noContactsMessage.textContent = 'No contacts found. Add one to get started!';
                    }
                } else {
                    noContactsMessage.classList.add('hidden');
                    contacts.forEach(contact => {
                        const card = document.createElement('div');
                        card.className = 'bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300';
                        card.innerHTML = `
                            <h3 class="text-xl font-bold text-gray-900 break-words">${contact.name}</h3>
                            <p class="text-gray-600 mt-2 break-words">${contact.phone}</p>
                            <p class="text-gray-500 mt-1 break-words">${contact.email}</p>
                            <div class="mt-6 flex justify-end space-x-3">
                                <button class="edit-btn text-blue-600 hover:text-blue-800 font-medium" data-id="${contact.id}">Edit</button>
                                <button class="delete-btn text-red-600 hover:text-red-800 font-medium" data-id="${contact.id}">Delete</button>
                            </div>
                        `;
                        contactsList.appendChild(card);
                    });
                }
            };

            contactForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveContact({
                    name: nameInput.value,
                    phone: phoneInput.value,
                    email: emailInput.value
                });
            });

            contactsList.addEventListener('click', (e) => {
                const target = e.target;
                const id = target.dataset.id;
                if (target.classList.contains('edit-btn')) {
                     fetch(`${API_URL}/${id}`)
                        .then(res => res.json())
                        .then(contact => openModal('Edit Contact', contact))
                        .catch(err => console.error('Failed to fetch contact for editing:', err));
                }
                if (target.classList.contains('delete-btn')) {
                    deleteContact(id);
                }
            });
            
            searchInput.addEventListener('input', () => {
                fetchContacts(searchInput.value);
            });

            fetchContacts();
        });
    </script>

</body>
</html>

