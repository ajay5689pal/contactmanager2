<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Management</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple transition for modal */
        .modal {
            transition: opacity 0.25s ease;
        }
        /* Custom styles for better form focus */
        input:focus {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
            border-color: rgba(59, 130, 246, 0.8);
            outline: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans leading-normal tracking-normal">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="mb-8">
            <div class="flex justify-between items-center">
                 <div class="flex items-center gap-3">
                    <!-- Title and new Contact Count Badge -->
                    <h1 class="text-3xl font-bold text-gray-900">My Contacts</h1>
                    <span id="contactCountBadge" class="bg-blue-100 text-blue-800 text-sm font-semibold px-2.5 py-0.5 rounded-full hidden">0</span>
                 </div>
                 <div class="text-right">
                    <!-- Welcome message and Logout link -->
                    <p class="text-sm text-gray-600 mb-1">Welcome, <span class="font-medium">{{ username }}</span>!</p>
                    <a href="/logout" class="text-sm text-blue-600 hover:text-blue-800 hover:underline">Logout</a>
                 </div>
            </div>
        </header>

        <!-- Search and Add Contact Bar -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div class="relative w-full md:w-1/2">
                <input type="text" id="searchInput" placeholder="Search contacts..." class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                </svg>
            </div>
            <button id="addContactBtn" class="w-full md:w-auto bg-blue-600 text-white px-5 py-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                Add New Contact
            </button>
        </div>

        <!-- Contacts List -->
        <div id="contactsContainer" class="bg-white rounded-lg shadow-md overflow-hidden">
            <ul id="contactsList">
                <!-- Contacts will be dynamically inserted here -->
            </ul>
            <div id="noContactsMessage" class="text-center p-8 text-gray-500 hidden">
                No contacts found.
            </div>
        </div>
    </div>

    <!-- Contact Form Modal -->
    <div id="contactModal" class="modal fixed inset-0 w-full h-full bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden" style="opacity: 0;">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6 text-gray-900">Add New Contact</h2>
            <form id="contactForm">
                <input type="hidden" id="contactId" name="id">
                <div class="mb-4">
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" id="name" name="name" class="w-full p-2 border border-gray-300 rounded-lg" required>
                </div>
                <div class="mb-4">
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                    <input type="tel" id="phone" name="phone" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div class="mb-6">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email" name="email" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" id="saveBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = window.location.origin + '/api/contacts';

            // Main elements
            const addContactBtn = document.getElementById('addContactBtn');
            const contactsList = document.getElementById('contactsList');
            const noContactsMessage = document.getElementById('noContactsMessage');
            const searchInput = document.getElementById('searchInput');
            const contactCountBadge = document.getElementById('contactCountBadge');

            // Modal elements
            const modal = document.getElementById('contactModal');
            const modalTitle = document.getElementById('modalTitle');
            const cancelBtn = document.getElementById('cancelBtn');
            const contactForm = document.getElementById('contactForm');
            const contactId = document.getElementById('contactId');
            const nameInput = document.getElementById('name');
            const phoneInput = document.getElementById('phone');
            const emailInput = document.getElementById('email');

            // --- Modal Functions ---
            const openModal = (title, contact = {}) => {
                modalTitle.textContent = title;
                contactId.value = contact.id || '';
                nameInput.value = contact.name || '';
                phoneInput.value = contact.phone || '';
                emailInput.value = contact.email || '';
                modal.classList.remove('hidden');
                setTimeout(() => modal.style.opacity = 1, 10);
            };

            const closeModal = () => {
                modal.style.opacity = 0;
                setTimeout(() => {
                    modal.classList.add('hidden');
                    contactForm.reset();
                }, 250);
            };

            // --- Event Listeners ---
            addContactBtn.addEventListener('click', () => openModal('Add New Contact'));
            cancelBtn.addEventListener('click', closeModal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            // --- Function to Fetch Contact Count ---
            const fetchContactCount = async () => {
                try {
                    // FIX: Add credentials: 'same-origin' to ensure cookies are sent
                    const response = await fetch(window.location.origin + '/api/contacts/count', {
                        credentials: 'same-origin'
                    });
                    
                    if (response.redirected) {
                        window.location.href = response.url;
                        return;
                    }
                    if (!response.ok) {
                        // FIX: Provide more detailed error message
                        throw new Error(`Failed to fetch count: ${response.status} ${response.statusText}`);
                    }
                    const data = await response.json();
                    contactCountBadge.textContent = data.count;
                    contactCountBadge.classList.remove('hidden');
                } catch (error) {
                    console.error('Failed to fetch contact count:', error);
                }
            };

            // --- Function to Fetch and Render Contacts ---
            const fetchContacts = async (searchTerm = '') => {
                try {
                    // FIX: Add credentials: 'same-origin' to ensure cookies are sent
                    const response = await fetch(`${API_URL}?search=${encodeURIComponent(searchTerm)}`, {
                        credentials: 'same-origin'
                    });
                    
                    if (response.redirected) {
                        window.location.href = response.url;
                        return;
                    }
                    if (!response.ok) {
                        // FIX: Provide more detailed error message
                        throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                    }
                    const contacts = await response.json();
                    renderContacts(contacts);
                } catch (error) {
                    console.error('Failed to fetch contacts:', error);
                    contactsList.innerHTML = `<li class="p-4 text-red-500">Error loading contacts. Please try again.</li>`;
                }
            };

            const renderContacts = (contacts) => {
                contactsList.innerHTML = '';
                if (contacts.length === 0) {
                    noContactsMessage.classList.remove('hidden');
                    contactsList.classList.add('hidden');
                } else {
                    noContactsMessage.classList.add('hidden');
                    contactsList.classList.remove('hidden');
                    contacts.forEach(contact => {
                        const li = document.createElement('li');
                        li.className = 'border-b border-gray-200 last:border-b-0';
                        li.innerHTML = `
                            <div class="flex flex-col md:flex-row items-start md:items-center justify-between p-4 hover:bg-gray-50">
                                <div class="mb-3 md:mb-0">
                                    <div class="font-bold text-lg text-gray-900">${contact.name}</div>
                                    <div class="text-sm text-gray-600">${contact.phone || ''}</div>
                                    <div class="text-sm text-gray-600">${contact.email || ''}</div>
                                </div>
                                <div class="flex space-x-2 flex-shrink-0">
                                    <button class="edit-btn p-2 text-blue-600 hover:text-blue-800" data-id="${contact.id}">
                                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                                        </svg>
                                    </button>
                                    <button class="delete-btn p-2 text-red-600 hover:text-red-800" data-id="${contact.id}">
                                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.502 0v-.001c0-.04.018-.08.05-.117A2.25 2.25 0 0 1 6.75 4h10.5a2.25 2.25 0 0 1 2.23 1.671a.11.11 0 0 1 .05.117Z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        `;
                        contactsList.appendChild(li);
                    });
                }
            };

            // --- Form Submission (Create/Update) ---
            contactForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = contactId.value;
                const contactData = {
                    name: nameInput.value,
                    phone: phoneInput.value,
                    email: emailInput.value,
                };
                
                const method = id ? 'PUT' : 'POST';
                const url = id ? `${API_URL}/${id}` : API_URL;

                try {
                    // FIX: Add credentials: 'same-origin' to ensure cookies are sent
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(contactData),
                        credentials: 'same-origin'
                    });
                    if (!response.ok) {
                        // FIX: Provide more detailed error message
                        throw new Error(`Failed to save contact: ${response.status} ${response.statusText}`);
                    }
                    closeModal();
                    fetchContacts(searchInput.value); // Refresh list
                    fetchContactCount(); // Update count after saving
                } catch (error) {
                    console.error('Error saving contact:', error);
                }
            });

            // --- Click Handling (Edit/Delete) ---
            contactsList.addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');

                if (editBtn) {
                    const id = editBtn.dataset.id;
                    try {
                        // FIX: Add credentials: 'same-origin' to ensure cookies are sent
                        const response = await fetch(`${API_URL}/${id}`, {
                            credentials: 'same-origin'
                        });
                        if (!response.ok) {
                            // FIX: Provide more detailed error message
                            throw new Error(`Failed to fetch contact for editing: ${response.status} ${response.statusText}`);
                        }
                        const contact = await response.json();
                        openModal('Edit Contact', contact);
                    } catch (error) {
                        console.error('Error fetching contact:', error);
                    }
                }

                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    if (confirm('Are you sure you want to delete this contact?')) {
                        try {
                            // FIX: Add credentials: 'same-origin' to ensure cookies are sent
                            const response = await fetch(`${API_URL}/${id}`, {
                                method: 'DELETE',
                                credentials: 'same-origin'
                            });
                            if (!response.ok) {
                                // FIX: Provide more detailed error message
                                throw new Error(`Failed to delete contact: ${response.status} ${response.statusText}`);
                            }
                            fetchContacts(searchInput.value); // Refresh list
                            fetchContactCount(); // Update count after deleting
                        } catch (error) {
                            console.error('Error deleting contact:', error);
                        }
                    }
                }
            });
            
            // --- Search Functionality ---
            searchInput.addEventListener('input', (e) => {
                fetchContacts(e.target.value);
            });

            // --- Initial Load ---
            fetchContacts();
            fetchContactCount();
        });
    </script>

</body>
</html>

